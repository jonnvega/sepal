#!/bin/bash

COMMAND=$1
WORKING_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

function start() {
  cd "$WORKING_DIR/../dev-env" || exit
  local RUNNING="$(docker compose ls | grep -e '^dev-env[ ]*running'| wc -l)"
  if [ "$RUNNING" -eq 1 ]
  then
    echo 'Joining already running dev-env...'
  else
    echo 'Starting dev-env...'
    docker compose up --build --remove-orphans -d
  fi
  docker exec -it sepal-dev bash
  cd - || exit
}

function stop() {
  cd "$WORKING_DIR/../dev-env" || exit
  echo 'Stopping dev-env...'
  docker compose down --remove-orphans
  cd - || exit
}

function usage() {
    echo ""
    echo "Usage:"
    echo ""
    echo "  $(basename $0) start                Start the dev-env"
    echo "  $(basename $0) stop                 Stop the dev-env"
    echo "  $(basename $0) restart              Restart the dev-env"
    echo ""
    echo "Options:"
    echo ""
    echo "  -c, --config    <config dir>    required for first start"
    echo "  -d, --data      <data dir>      optional (default ./sepal-data)"
    echo ""
    exit 1
}

case "$COMMAND" in
    start)
        start
        RETVAL=$?
        ;;
    stop)
        stop
        RETVAL=$?
        ;;
    restart)
        stop
        start
        RETVAL=$?
        ;;
    *)
        usage
        RETVAL=1
        ;;
esac

exit $RETVAL
